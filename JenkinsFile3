pipeline {
    agent any

    stages {

        stage('Pull Code') {
            steps {
                git branch: 'main', url: 'https://github.com/ranjana3005/blue-green-deployment.git'
            }
        }

        stage('Deploy Blue') {
            steps {
                bat 'docker stop blue || exit 0'
                bat 'docker rm blue || exit 0'
                bat 'docker run -d --name blue -p 8081:3000 ranjana4047/blue-green-app:v1'
            }
        }

        stage('Deploy Green') {
            steps {
                bat 'docker stop green || exit 0'
                bat 'docker rm green || exit 0'
                bat 'docker run -d --name green -p 8082:3000 ranjana4047/blue-green-app:v2'
            }
        }

        stage('Health Check') {
            steps {
                script {
                    def green_status = bat(
                        script: 'powershell -Command "(Invoke-WebRequest http://localhost:8082).Content"',
                        returnStdout: true
                    ).trim()

                    if (!green_status.contains('Green')) {
                        error("❌ Green deployment failed")
                    }
                }
            }
        }

        stage('Switch Traffic') {
            steps {
                bat 'docker stop blue || exit 0'
                echo '✅ Traffic switched to GREEN deployment'
            }
        }
    }
}
